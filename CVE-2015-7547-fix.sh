#!/bin/sh

# Copyright (c) 2002-2016 by 4PSA
# All rights reserved
#
# This script patches CVE-2015-7547

if [  -x "/usr/bin/firewalld" ];then
        systemctl status firewalld >/dev/null 2>&1
        if [ "$?" == "0" ];then
                usefirewalld=1
        fi
        if [ ! -x "/usr/bin/firewall-cmd" ];then
                usefirewalld=0
        fi
fi
if [ "$usefirewalld" == "1" ];then
        firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -p udp --sport 53 -m length --length 1024: -j DROP
        firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -p tcp --sport 53 -m length --length 1024: -j DROP
        firewall-cmd --permanent --direct --add-rule ipv6 filter INPUT 0 -p udp --sport 53 -m length --length 1024: -j DROP
        firewall-cmd --permanent --direct --add-rule ipv6 filter INPUT 0 -p tcp --sport 53 -m length --length 1024: -j DROP
else

        if [ "`iptables -L -vn|grep -c 'tcp spt:53 length'`" == "0" ];then
                iptables -I INPUT -p udp --sport 53 -m length --length 1024: -j DROP
                iptables -I INPUT -p tcp --sport 53 -m length --length 1024: -j DROP
                if [ -f /etc/redhat-release ];then
                        iptables-save > /etc/sysconfig/iptables
                fi
                if [ -f /etc/debian_version ];then
                        iptables-save > /etc/iptables/rules.v4
                fi
        fi
        if [ -x "/usr/sbin/ip6tables" ];then
                if [ "`/usr/sbin/ip6tables -L -vn|grep -c 'tcp spt:53 length'`" == "0" ];then
                        if [ -x "/usr/sbin/ip6tables" ];then
                                ip6tables -I INPUT -p udp --sport 53 -m length --length 1024: -j DROP
                                ip6tables -I INPUT -p tcp --sport 53 -m length --length 1024: -j DROP
                                if [ -f /etc/redhat-release ];then
                                        ip6tables-save > /etc/sysconfig/ip6tables
                                fi
                                if [ -f /etc/debian_version ];then
                                        ip6tables-save >/etc/iptables/rules.v6
                                fi
                        fi
                fi
        fi
fi
